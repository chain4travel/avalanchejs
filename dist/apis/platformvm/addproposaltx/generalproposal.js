"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.GeneralProposal = exports.GeneralVoteOption = void 0;
const buffer_1 = require("buffer/");
const constants_1 = require("../constants");
const serialization_1 = require("../../../utils/serialization");
const bintools_1 = __importDefault(require("../../../utils/bintools"));
const utf8 = "utf8";
const serialization = serialization_1.Serialization.getInstance();
const bintools = bintools_1.default.getInstance();
class GeneralVoteOption extends serialization_1.Serializable {
    serialize(encoding = "hex") {
        super.serialize();
        return {
            option: serialization.encoder(this.option, encoding, "Buffer", "hex")
        };
    }
    deserialize(fields, encoding = "hex") {
        super.deserialize(fields, encoding);
        this.option = serialization.decoder(fields["option"], encoding, "Buffer", "Buffer", 256 //max size
        );
        return this;
    }
    fromBuffer(bytes, offset = 0) {
        let optionLen = bintools
            .copyFrom(bytes, offset, offset + 4)
            .readUInt32BE(0);
        offset += 4;
        this.option = bintools.copyFrom(bytes, offset, offset + optionLen);
        offset += optionLen;
        return offset;
    }
    toBuffer() {
        let barr = [buffer_1.Buffer.alloc(4), this.option];
        let bsize = 4 + this.option.length;
        barr[0].writeUInt32BE(this.option.length, 0);
        return buffer_1.Buffer.concat(barr, bsize);
    }
    getSize() {
        return this.option.length + 4;
    }
    getOption() {
        return this.option;
    }
    constructor(option) {
        super();
        this._typeName = "GeneralVoteOption";
        this._typeID = undefined;
        this.option = buffer_1.Buffer.alloc(0);
        if (option)
            this.option = option;
    }
}
exports.GeneralVoteOption = GeneralVoteOption;
class GeneralProposal {
    addGeneralOption(option) {
        const generalVoteOption = new GeneralVoteOption(buffer_1.Buffer.from(option));
        this.options.push(generalVoteOption);
        if (this.options) {
            this.numOptions.writeUInt32BE(this.options.length, 0);
        }
        return this.options.length - 1;
    }
    serialize(encoding = "hex") {
        let fields = {
            start: serialization.encoder(this.start, encoding, "Buffer", "number"),
            end: serialization.encoder(this.end, encoding, "Buffer", "number"),
            options: this.options.map((opt) => opt.serialize(encoding)),
            totalVotedThresholdNominator: serialization.encoder(this.totalVotedThresholdNominator, encoding, "Buffer", "number"),
            mostVotedThresholdNominator: serialization.encoder(this.mostVotedThresholdNominator, encoding, "Buffer", "number"),
            allowEarlyFinish: this.allowEarlyFinish
        };
        return fields;
    }
    deserialize(fields, encoding = "hex") {
        this.numOptions.writeUInt32BE(this.options.length, 0);
        this.options = fields["options"].map((opt) => new GeneralVoteOption().deserialize(opt, encoding));
        this.start = serialization.decoder(fields["start"], encoding, "number", "Buffer");
        this.end = serialization.decoder(fields["end"], encoding, "number", "Buffer");
        this.totalVotedThresholdNominator = serialization.decoder(fields["totalVotedThresholdNominator"], encoding, "number", "Buffer");
        this.mostVotedThresholdNominator = serialization.decoder(fields["mostVotedThresholdNominator"], encoding, "number", "Buffer");
        this.allowEarlyFinish = serialization.decoder(fields["allowEarlyFinish"], encoding, "number", "Buffer");
        return this;
    }
    fromBuffer(bytes, offset = 0) {
        this.numOptions = bintools.copyFrom(bytes, offset, offset + 4); // this.numOptions.readUInt32BE(0)
        offset += 4;
        const optionCount = this.numOptions.readUInt32BE(0);
        this.options = [];
        for (let i = 0; i < optionCount; i++) {
            const option = new GeneralVoteOption();
            offset = option.fromBuffer(bytes, offset);
            this.options.push(option);
        }
        this.start = bintools.copyFrom(bytes, offset, offset + 8);
        offset += 8;
        this.end = bintools.copyFrom(bytes, offset, offset + 8);
        offset += 8;
        this.totalVotedThresholdNominator = bintools.copyFrom(bytes, offset, offset + 8);
        offset += 8;
        this.mostVotedThresholdNominator = bintools.copyFrom(bytes, offset, offset + 8);
        offset += 8;
        this.allowEarlyFinish = bintools.copyFrom(bytes, offset, offset + 1)[0] != 0;
        offset += 1;
        return offset;
    }
    toBuffer() {
        let barr = [this.numOptions];
        let bsize = this.numOptions.length;
        this.options.forEach((opt) => {
            let optBuffer = opt.toBuffer();
            barr.push(optBuffer);
            bsize += optBuffer.length;
        });
        barr.push(this.start, this.end, this.totalVotedThresholdNominator, this.mostVotedThresholdNominator, buffer_1.Buffer.from([this.allowEarlyFinish ? 1 : 0]));
        bsize +=
            this.start.length +
                this.end.length +
                this.totalVotedThresholdNominator.length +
                this.mostVotedThresholdNominator.length +
                1;
        return buffer_1.Buffer.concat(barr, bsize);
    }
    constructor(start, end, totalVotedThresholdNominator, mostVotedThresholdNominator, allowEarlyFinish) {
        this._typeID = constants_1.PlatformVMConstants.GENERALPROPOSAL_TYPE_ID;
        // The order is important, must be followed in functions
        this.numOptions = buffer_1.Buffer.alloc(4); //1.
        this.start = buffer_1.Buffer.alloc(8); //3.
        this.end = buffer_1.Buffer.alloc(8); //4.
        this.totalVotedThresholdNominator = buffer_1.Buffer.alloc(8); //5.
        this.mostVotedThresholdNominator = buffer_1.Buffer.alloc(8); //6.
        const startTime = buffer_1.Buffer.alloc(8); // Buffer to hold the start time, 8 bytes
        startTime.writeUInt32BE(start, 4);
        const endTime = buffer_1.Buffer.alloc(8); // Buffer to hold the end time, 8 bytes
        endTime.writeUInt32BE(end, 4);
        this.options = [];
        this.start = startTime;
        this.end = endTime;
        this.totalVotedThresholdNominator = buffer_1.Buffer.alloc(8);
        this.totalVotedThresholdNominator.writeUInt32BE(totalVotedThresholdNominator, 0);
        this.mostVotedThresholdNominator = buffer_1.Buffer.alloc(8);
        this.mostVotedThresholdNominator.writeUInt32BE(mostVotedThresholdNominator, 0);
        this.allowEarlyFinish = allowEarlyFinish;
    }
    getTypeID() {
        return this._typeID;
    }
    getAllowEarlyFinish() {
        return this.allowEarlyFinish;
    }
}
exports.GeneralProposal = GeneralProposal;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZ2VuZXJhbHByb3Bvc2FsLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vc3JjL2FwaXMvcGxhdGZvcm12bS9hZGRwcm9wb3NhbHR4L2dlbmVyYWxwcm9wb3NhbC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7QUFBQSxvQ0FBZ0M7QUFDaEMsNENBQWtEO0FBQ2xELGdFQUtxQztBQUNyQyx1RUFBOEM7QUFDOUMsTUFBTSxJQUFJLEdBQW1CLE1BQU0sQ0FBQTtBQUVuQyxNQUFNLGFBQWEsR0FBRyw2QkFBYSxDQUFDLFdBQVcsRUFBRSxDQUFBO0FBQ2pELE1BQU0sUUFBUSxHQUFhLGtCQUFRLENBQUMsV0FBVyxFQUFFLENBQUE7QUFFakQsTUFBYSxpQkFBa0IsU0FBUSw0QkFBWTtJQU1qRCxTQUFTLENBQUMsV0FBK0IsS0FBSztRQUM1QyxLQUFLLENBQUMsU0FBUyxFQUFFLENBQUE7UUFDakIsT0FBTztZQUNMLE1BQU0sRUFBRSxhQUFhLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxNQUFNLEVBQUUsUUFBUSxFQUFFLFFBQVEsRUFBRSxLQUFLLENBQUM7U0FDdEUsQ0FBQTtJQUNILENBQUM7SUFDRCxXQUFXLENBQUMsTUFBYyxFQUFFLFdBQStCLEtBQUs7UUFDOUQsS0FBSyxDQUFDLFdBQVcsQ0FBQyxNQUFNLEVBQUUsUUFBUSxDQUFDLENBQUE7UUFDbkMsSUFBSSxDQUFDLE1BQU0sR0FBRyxhQUFhLENBQUMsT0FBTyxDQUNqQyxNQUFNLENBQUMsUUFBUSxDQUFDLEVBQ2hCLFFBQVEsRUFDUixRQUFRLEVBQ1IsUUFBUSxFQUNSLEdBQUcsQ0FBQyxVQUFVO1NBQ2YsQ0FBQTtRQUVELE9BQU8sSUFBSSxDQUFBO0lBQ2IsQ0FBQztJQUVELFVBQVUsQ0FBQyxLQUFhLEVBQUUsU0FBaUIsQ0FBQztRQUMxQyxJQUFJLFNBQVMsR0FBVyxRQUFRO2FBQzdCLFFBQVEsQ0FBQyxLQUFLLEVBQUUsTUFBTSxFQUFFLE1BQU0sR0FBRyxDQUFDLENBQUM7YUFDbkMsWUFBWSxDQUFDLENBQUMsQ0FBQyxDQUFBO1FBQ2xCLE1BQU0sSUFBSSxDQUFDLENBQUE7UUFDWCxJQUFJLENBQUMsTUFBTSxHQUFHLFFBQVEsQ0FBQyxRQUFRLENBQUMsS0FBSyxFQUFFLE1BQU0sRUFBRSxNQUFNLEdBQUcsU0FBUyxDQUFDLENBQUE7UUFDbEUsTUFBTSxJQUFJLFNBQVMsQ0FBQTtRQUNuQixPQUFPLE1BQU0sQ0FBQTtJQUNmLENBQUM7SUFDRCxRQUFRO1FBQ04sSUFBSSxJQUFJLEdBQUcsQ0FBQyxlQUFNLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxFQUFFLElBQUksQ0FBQyxNQUFNLENBQUMsQ0FBQTtRQUN6QyxJQUFJLEtBQUssR0FBRyxDQUFDLEdBQUcsSUFBSSxDQUFDLE1BQU0sQ0FBQyxNQUFNLENBQUE7UUFDbEMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDLGFBQWEsQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLE1BQU0sRUFBRSxDQUFDLENBQUMsQ0FBQTtRQUM1QyxPQUFPLGVBQU0sQ0FBQyxNQUFNLENBQUMsSUFBSSxFQUFFLEtBQUssQ0FBQyxDQUFBO0lBQ25DLENBQUM7SUFFRCxPQUFPO1FBQ0wsT0FBTyxJQUFJLENBQUMsTUFBTSxDQUFDLE1BQU0sR0FBRyxDQUFDLENBQUE7SUFDL0IsQ0FBQztJQUVELFNBQVM7UUFDUCxPQUFPLElBQUksQ0FBQyxNQUFNLENBQUE7SUFDcEIsQ0FBQztJQUNELFlBQVksTUFBZTtRQUN6QixLQUFLLEVBQUUsQ0FBQTtRQWhEQyxjQUFTLEdBQUcsbUJBQW1CLENBQUE7UUFDL0IsWUFBTyxHQUFHLFNBQVMsQ0FBQTtRQUVuQixXQUFNLEdBQVcsZUFBTSxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQTtRQThDeEMsSUFBSSxNQUFNO1lBQUUsSUFBSSxDQUFDLE1BQU0sR0FBRyxNQUFNLENBQUE7SUFDbEMsQ0FBQztDQUNGO0FBcERELDhDQW9EQztBQUNELE1BQWEsZUFBZTtJQWMxQixnQkFBZ0IsQ0FBQyxNQUFjO1FBQzdCLE1BQU0saUJBQWlCLEdBQUcsSUFBSSxpQkFBaUIsQ0FBQyxlQUFNLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUE7UUFDcEUsSUFBSSxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsaUJBQWlCLENBQUMsQ0FBQTtRQUNwQyxJQUFJLElBQUksQ0FBQyxPQUFPLEVBQUU7WUFDaEIsSUFBSSxDQUFDLFVBQVUsQ0FBQyxhQUFhLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxNQUFNLEVBQUUsQ0FBQyxDQUFDLENBQUE7U0FDdEQ7UUFDRCxPQUFPLElBQUksQ0FBQyxPQUFPLENBQUMsTUFBTSxHQUFHLENBQUMsQ0FBQTtJQUNoQyxDQUFDO0lBRUQsU0FBUyxDQUFDLFdBQStCLEtBQUs7UUFDNUMsSUFBSSxNQUFNLEdBQUc7WUFDWCxLQUFLLEVBQUUsYUFBYSxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsS0FBSyxFQUFFLFFBQVEsRUFBRSxRQUFRLEVBQUUsUUFBUSxDQUFDO1lBQ3RFLEdBQUcsRUFBRSxhQUFhLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxHQUFHLEVBQUUsUUFBUSxFQUFFLFFBQVEsRUFBRSxRQUFRLENBQUM7WUFDbEUsT0FBTyxFQUFFLElBQUksQ0FBQyxPQUFPLENBQUMsR0FBRyxDQUFDLENBQUMsR0FBRyxFQUFFLEVBQUUsQ0FBQyxHQUFHLENBQUMsU0FBUyxDQUFDLFFBQVEsQ0FBQyxDQUFDO1lBQzNELDRCQUE0QixFQUFFLGFBQWEsQ0FBQyxPQUFPLENBQ2pELElBQUksQ0FBQyw0QkFBNEIsRUFDakMsUUFBUSxFQUNSLFFBQVEsRUFDUixRQUFRLENBQ1Q7WUFDRCwyQkFBMkIsRUFBRSxhQUFhLENBQUMsT0FBTyxDQUNoRCxJQUFJLENBQUMsMkJBQTJCLEVBQ2hDLFFBQVEsRUFDUixRQUFRLEVBQ1IsUUFBUSxDQUNUO1lBQ0QsZ0JBQWdCLEVBQUUsSUFBSSxDQUFDLGdCQUFnQjtTQUN4QyxDQUFBO1FBQ0QsT0FBTyxNQUFNLENBQUE7SUFDZixDQUFDO0lBRUQsV0FBVyxDQUFDLE1BQWMsRUFBRSxXQUErQixLQUFLO1FBQzlELElBQUksQ0FBQyxVQUFVLENBQUMsYUFBYSxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsTUFBTSxFQUFFLENBQUMsQ0FBQyxDQUFBO1FBQ3JELElBQUksQ0FBQyxPQUFPLEdBQUcsTUFBTSxDQUFDLFNBQVMsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDLEdBQUcsRUFBRSxFQUFFLENBQzNDLElBQUksaUJBQWlCLEVBQUUsQ0FBQyxXQUFXLENBQUMsR0FBRyxFQUFFLFFBQVEsQ0FBQyxDQUNuRCxDQUFBO1FBQ0QsSUFBSSxDQUFDLEtBQUssR0FBRyxhQUFhLENBQUMsT0FBTyxDQUNoQyxNQUFNLENBQUMsT0FBTyxDQUFDLEVBQ2YsUUFBUSxFQUNSLFFBQVEsRUFDUixRQUFRLENBQ1QsQ0FBQTtRQUNELElBQUksQ0FBQyxHQUFHLEdBQUcsYUFBYSxDQUFDLE9BQU8sQ0FDOUIsTUFBTSxDQUFDLEtBQUssQ0FBQyxFQUNiLFFBQVEsRUFDUixRQUFRLEVBQ1IsUUFBUSxDQUNULENBQUE7UUFDRCxJQUFJLENBQUMsNEJBQTRCLEdBQUcsYUFBYSxDQUFDLE9BQU8sQ0FDdkQsTUFBTSxDQUFDLDhCQUE4QixDQUFDLEVBQ3RDLFFBQVEsRUFDUixRQUFRLEVBQ1IsUUFBUSxDQUNULENBQUE7UUFDRCxJQUFJLENBQUMsMkJBQTJCLEdBQUcsYUFBYSxDQUFDLE9BQU8sQ0FDdEQsTUFBTSxDQUFDLDZCQUE2QixDQUFDLEVBQ3JDLFFBQVEsRUFDUixRQUFRLEVBQ1IsUUFBUSxDQUNULENBQUE7UUFFRCxJQUFJLENBQUMsZ0JBQWdCLEdBQUcsYUFBYSxDQUFDLE9BQU8sQ0FDM0MsTUFBTSxDQUFDLGtCQUFrQixDQUFDLEVBQzFCLFFBQVEsRUFDUixRQUFRLEVBQ1IsUUFBUSxDQUNULENBQUE7UUFFRCxPQUFPLElBQUksQ0FBQTtJQUNiLENBQUM7SUFFRCxVQUFVLENBQUMsS0FBYSxFQUFFLFNBQWlCLENBQUM7UUFDMUMsSUFBSSxDQUFDLFVBQVUsR0FBRyxRQUFRLENBQUMsUUFBUSxDQUFDLEtBQUssRUFBRSxNQUFNLEVBQUUsTUFBTSxHQUFHLENBQUMsQ0FBQyxDQUFBLENBQUMsa0NBQWtDO1FBQ2pHLE1BQU0sSUFBSSxDQUFDLENBQUE7UUFDWCxNQUFNLFdBQVcsR0FBRyxJQUFJLENBQUMsVUFBVSxDQUFDLFlBQVksQ0FBQyxDQUFDLENBQUMsQ0FBQTtRQUNuRCxJQUFJLENBQUMsT0FBTyxHQUFHLEVBQUUsQ0FBQTtRQUNqQixLQUFLLElBQUksQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLEdBQUcsV0FBVyxFQUFFLENBQUMsRUFBRSxFQUFFO1lBQ3BDLE1BQU0sTUFBTSxHQUFHLElBQUksaUJBQWlCLEVBQUUsQ0FBQTtZQUN0QyxNQUFNLEdBQUcsTUFBTSxDQUFDLFVBQVUsQ0FBQyxLQUFLLEVBQUUsTUFBTSxDQUFDLENBQUE7WUFDekMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLENBQUE7U0FDMUI7UUFDRCxJQUFJLENBQUMsS0FBSyxHQUFHLFFBQVEsQ0FBQyxRQUFRLENBQUMsS0FBSyxFQUFFLE1BQU0sRUFBRSxNQUFNLEdBQUcsQ0FBQyxDQUFDLENBQUE7UUFDekQsTUFBTSxJQUFJLENBQUMsQ0FBQTtRQUNYLElBQUksQ0FBQyxHQUFHLEdBQUcsUUFBUSxDQUFDLFFBQVEsQ0FBQyxLQUFLLEVBQUUsTUFBTSxFQUFFLE1BQU0sR0FBRyxDQUFDLENBQUMsQ0FBQTtRQUN2RCxNQUFNLElBQUksQ0FBQyxDQUFBO1FBQ1gsSUFBSSxDQUFDLDRCQUE0QixHQUFHLFFBQVEsQ0FBQyxRQUFRLENBQ25ELEtBQUssRUFDTCxNQUFNLEVBQ04sTUFBTSxHQUFHLENBQUMsQ0FDWCxDQUFBO1FBQ0QsTUFBTSxJQUFJLENBQUMsQ0FBQTtRQUNYLElBQUksQ0FBQywyQkFBMkIsR0FBRyxRQUFRLENBQUMsUUFBUSxDQUNsRCxLQUFLLEVBQ0wsTUFBTSxFQUNOLE1BQU0sR0FBRyxDQUFDLENBQ1gsQ0FBQTtRQUNELE1BQU0sSUFBSSxDQUFDLENBQUE7UUFFWCxJQUFJLENBQUMsZ0JBQWdCLEdBQUcsUUFBUSxDQUFDLFFBQVEsQ0FBQyxLQUFLLEVBQUUsTUFBTSxFQUFFLE1BQU0sR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLENBQUE7UUFDNUUsTUFBTSxJQUFJLENBQUMsQ0FBQTtRQUVYLE9BQU8sTUFBTSxDQUFBO0lBQ2YsQ0FBQztJQUVELFFBQVE7UUFDTixJQUFJLElBQUksR0FBRyxDQUFDLElBQUksQ0FBQyxVQUFVLENBQUMsQ0FBQTtRQUM1QixJQUFJLEtBQUssR0FBRyxJQUFJLENBQUMsVUFBVSxDQUFDLE1BQU0sQ0FBQTtRQUVsQyxJQUFJLENBQUMsT0FBTyxDQUFDLE9BQU8sQ0FBQyxDQUFDLEdBQUcsRUFBRSxFQUFFO1lBQzNCLElBQUksU0FBUyxHQUFHLEdBQUcsQ0FBQyxRQUFRLEVBQUUsQ0FBQTtZQUM5QixJQUFJLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxDQUFBO1lBQ3BCLEtBQUssSUFBSSxTQUFTLENBQUMsTUFBTSxDQUFBO1FBQzNCLENBQUMsQ0FBQyxDQUFBO1FBRUYsSUFBSSxDQUFDLElBQUksQ0FDUCxJQUFJLENBQUMsS0FBSyxFQUNWLElBQUksQ0FBQyxHQUFHLEVBQ1IsSUFBSSxDQUFDLDRCQUE0QixFQUNqQyxJQUFJLENBQUMsMkJBQTJCLEVBQ2hDLGVBQU0sQ0FBQyxJQUFJLENBQUMsQ0FBQyxJQUFJLENBQUMsZ0JBQWdCLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FDN0MsQ0FBQTtRQUVELEtBQUs7WUFDSCxJQUFJLENBQUMsS0FBSyxDQUFDLE1BQU07Z0JBQ2pCLElBQUksQ0FBQyxHQUFHLENBQUMsTUFBTTtnQkFDZixJQUFJLENBQUMsNEJBQTRCLENBQUMsTUFBTTtnQkFDeEMsSUFBSSxDQUFDLDJCQUEyQixDQUFDLE1BQU07Z0JBQ3ZDLENBQUMsQ0FBQTtRQUVILE9BQU8sZUFBTSxDQUFDLE1BQU0sQ0FBQyxJQUFJLEVBQUUsS0FBSyxDQUFDLENBQUE7SUFDbkMsQ0FBQztJQUVELFlBQ0UsS0FBYyxFQUNkLEdBQVksRUFDWiw0QkFBcUMsRUFDckMsMkJBQW9DLEVBQ3BDLGdCQUEwQjtRQXRKWCxZQUFPLEdBQUcsK0JBQW1CLENBQUMsdUJBQXVCLENBQUE7UUFFdEUsd0RBQXdEO1FBQzlDLGVBQVUsR0FBVyxlQUFNLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFBLENBQUMsSUFBSTtRQUd6QyxVQUFLLEdBQVcsZUFBTSxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQSxDQUFDLElBQUk7UUFDcEMsUUFBRyxHQUFXLGVBQU0sQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUEsQ0FBQyxJQUFJO1FBRWxDLGlDQUE0QixHQUFXLGVBQU0sQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUEsQ0FBQyxJQUFJO1FBQzNELGdDQUEyQixHQUFXLGVBQU0sQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUEsQ0FBQyxJQUFJO1FBOElsRSxNQUFNLFNBQVMsR0FBRyxlQUFNLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFBLENBQUMseUNBQXlDO1FBQzNFLFNBQVMsQ0FBQyxhQUFhLENBQUMsS0FBSyxFQUFFLENBQUMsQ0FBQyxDQUFBO1FBQ2pDLE1BQU0sT0FBTyxHQUFHLGVBQU0sQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUEsQ0FBQyx1Q0FBdUM7UUFDdkUsT0FBTyxDQUFDLGFBQWEsQ0FBQyxHQUFHLEVBQUUsQ0FBQyxDQUFDLENBQUE7UUFFN0IsSUFBSSxDQUFDLE9BQU8sR0FBRyxFQUFFLENBQUE7UUFDakIsSUFBSSxDQUFDLEtBQUssR0FBRyxTQUFTLENBQUE7UUFDdEIsSUFBSSxDQUFDLEdBQUcsR0FBRyxPQUFPLENBQUE7UUFFbEIsSUFBSSxDQUFDLDRCQUE0QixHQUFHLGVBQU0sQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUE7UUFDbkQsSUFBSSxDQUFDLDRCQUE0QixDQUFDLGFBQWEsQ0FDN0MsNEJBQTRCLEVBQzVCLENBQUMsQ0FDRixDQUFBO1FBQ0QsSUFBSSxDQUFDLDJCQUEyQixHQUFHLGVBQU0sQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUE7UUFDbEQsSUFBSSxDQUFDLDJCQUEyQixDQUFDLGFBQWEsQ0FDNUMsMkJBQTJCLEVBQzNCLENBQUMsQ0FDRixDQUFBO1FBQ0QsSUFBSSxDQUFDLGdCQUFnQixHQUFHLGdCQUFnQixDQUFBO0lBQzFDLENBQUM7SUFFRCxTQUFTO1FBQ1AsT0FBTyxJQUFJLENBQUMsT0FBTyxDQUFBO0lBQ3JCLENBQUM7SUFFRCxtQkFBbUI7UUFDakIsT0FBTyxJQUFJLENBQUMsZ0JBQWdCLENBQUE7SUFDOUIsQ0FBQztDQUNGO0FBdExELDBDQXNMQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEJ1ZmZlciB9IGZyb20gXCJidWZmZXIvXCJcbmltcG9ydCB7IFBsYXRmb3JtVk1Db25zdGFudHMgfSBmcm9tIFwiLi4vY29uc3RhbnRzXCJcbmltcG9ydCB7XG4gIFNlcmlhbGl6YWJsZSxcbiAgU2VyaWFsaXphdGlvbixcbiAgU2VyaWFsaXplZEVuY29kaW5nLFxuICBTZXJpYWxpemVkVHlwZVxufSBmcm9tIFwiLi4vLi4vLi4vdXRpbHMvc2VyaWFsaXphdGlvblwiXG5pbXBvcnQgQmluVG9vbHMgZnJvbSBcIi4uLy4uLy4uL3V0aWxzL2JpbnRvb2xzXCJcbmNvbnN0IHV0Zjg6IFNlcmlhbGl6ZWRUeXBlID0gXCJ1dGY4XCJcblxuY29uc3Qgc2VyaWFsaXphdGlvbiA9IFNlcmlhbGl6YXRpb24uZ2V0SW5zdGFuY2UoKVxuY29uc3QgYmludG9vbHM6IEJpblRvb2xzID0gQmluVG9vbHMuZ2V0SW5zdGFuY2UoKVxuXG5leHBvcnQgY2xhc3MgR2VuZXJhbFZvdGVPcHRpb24gZXh0ZW5kcyBTZXJpYWxpemFibGUge1xuICBwcm90ZWN0ZWQgX3R5cGVOYW1lID0gXCJHZW5lcmFsVm90ZU9wdGlvblwiXG4gIHByb3RlY3RlZCBfdHlwZUlEID0gdW5kZWZpbmVkXG5cbiAgcHJvdGVjdGVkIG9wdGlvbjogQnVmZmVyID0gQnVmZmVyLmFsbG9jKDApXG5cbiAgc2VyaWFsaXplKGVuY29kaW5nOiBTZXJpYWxpemVkRW5jb2RpbmcgPSBcImhleFwiKTogb2JqZWN0IHtcbiAgICBzdXBlci5zZXJpYWxpemUoKVxuICAgIHJldHVybiB7XG4gICAgICBvcHRpb246IHNlcmlhbGl6YXRpb24uZW5jb2Rlcih0aGlzLm9wdGlvbiwgZW5jb2RpbmcsIFwiQnVmZmVyXCIsIFwiaGV4XCIpXG4gICAgfVxuICB9XG4gIGRlc2VyaWFsaXplKGZpZWxkczogb2JqZWN0LCBlbmNvZGluZzogU2VyaWFsaXplZEVuY29kaW5nID0gXCJoZXhcIik6IHRoaXMge1xuICAgIHN1cGVyLmRlc2VyaWFsaXplKGZpZWxkcywgZW5jb2RpbmcpXG4gICAgdGhpcy5vcHRpb24gPSBzZXJpYWxpemF0aW9uLmRlY29kZXIoXG4gICAgICBmaWVsZHNbXCJvcHRpb25cIl0sXG4gICAgICBlbmNvZGluZyxcbiAgICAgIFwiQnVmZmVyXCIsXG4gICAgICBcIkJ1ZmZlclwiLFxuICAgICAgMjU2IC8vbWF4IHNpemVcbiAgICApXG5cbiAgICByZXR1cm4gdGhpc1xuICB9XG5cbiAgZnJvbUJ1ZmZlcihieXRlczogQnVmZmVyLCBvZmZzZXQ6IG51bWJlciA9IDApOiBudW1iZXIge1xuICAgIGxldCBvcHRpb25MZW46IG51bWJlciA9IGJpbnRvb2xzXG4gICAgICAuY29weUZyb20oYnl0ZXMsIG9mZnNldCwgb2Zmc2V0ICsgNClcbiAgICAgIC5yZWFkVUludDMyQkUoMClcbiAgICBvZmZzZXQgKz0gNFxuICAgIHRoaXMub3B0aW9uID0gYmludG9vbHMuY29weUZyb20oYnl0ZXMsIG9mZnNldCwgb2Zmc2V0ICsgb3B0aW9uTGVuKVxuICAgIG9mZnNldCArPSBvcHRpb25MZW5cbiAgICByZXR1cm4gb2Zmc2V0XG4gIH1cbiAgdG9CdWZmZXIoKTogQnVmZmVyIHtcbiAgICBsZXQgYmFyciA9IFtCdWZmZXIuYWxsb2MoNCksIHRoaXMub3B0aW9uXVxuICAgIGxldCBic2l6ZSA9IDQgKyB0aGlzLm9wdGlvbi5sZW5ndGhcbiAgICBiYXJyWzBdLndyaXRlVUludDMyQkUodGhpcy5vcHRpb24ubGVuZ3RoLCAwKVxuICAgIHJldHVybiBCdWZmZXIuY29uY2F0KGJhcnIsIGJzaXplKVxuICB9XG5cbiAgZ2V0U2l6ZSgpOiBudW1iZXIge1xuICAgIHJldHVybiB0aGlzLm9wdGlvbi5sZW5ndGggKyA0XG4gIH1cblxuICBnZXRPcHRpb24oKTogQnVmZmVyIHtcbiAgICByZXR1cm4gdGhpcy5vcHRpb25cbiAgfVxuICBjb25zdHJ1Y3RvcihvcHRpb24/OiBCdWZmZXIpIHtcbiAgICBzdXBlcigpXG4gICAgaWYgKG9wdGlvbikgdGhpcy5vcHRpb24gPSBvcHRpb25cbiAgfVxufVxuZXhwb3J0IGNsYXNzIEdlbmVyYWxQcm9wb3NhbCB7XG4gIHByaXZhdGUgcmVhZG9ubHkgX3R5cGVJRCA9IFBsYXRmb3JtVk1Db25zdGFudHMuR0VORVJBTFBST1BPU0FMX1RZUEVfSURcblxuICAvLyBUaGUgb3JkZXIgaXMgaW1wb3J0YW50LCBtdXN0IGJlIGZvbGxvd2VkIGluIGZ1bmN0aW9uc1xuICBwcm90ZWN0ZWQgbnVtT3B0aW9uczogQnVmZmVyID0gQnVmZmVyLmFsbG9jKDQpIC8vMS5cbiAgcHJvdGVjdGVkIG9wdGlvbnM6IEdlbmVyYWxWb3RlT3B0aW9uW10gLy8yLlxuXG4gIHByb3RlY3RlZCBzdGFydDogQnVmZmVyID0gQnVmZmVyLmFsbG9jKDgpIC8vMy5cbiAgcHJvdGVjdGVkIGVuZDogQnVmZmVyID0gQnVmZmVyLmFsbG9jKDgpIC8vNC5cblxuICBwcm90ZWN0ZWQgdG90YWxWb3RlZFRocmVzaG9sZE5vbWluYXRvcjogQnVmZmVyID0gQnVmZmVyLmFsbG9jKDgpIC8vNS5cbiAgcHJvdGVjdGVkIG1vc3RWb3RlZFRocmVzaG9sZE5vbWluYXRvcjogQnVmZmVyID0gQnVmZmVyLmFsbG9jKDgpIC8vNi5cbiAgcHJvdGVjdGVkIGFsbG93RWFybHlGaW5pc2g6IGJvb2xlYW4gLy8gNy5cblxuICBhZGRHZW5lcmFsT3B0aW9uKG9wdGlvbjogc3RyaW5nKTogbnVtYmVyIHtcbiAgICBjb25zdCBnZW5lcmFsVm90ZU9wdGlvbiA9IG5ldyBHZW5lcmFsVm90ZU9wdGlvbihCdWZmZXIuZnJvbShvcHRpb24pKVxuICAgIHRoaXMub3B0aW9ucy5wdXNoKGdlbmVyYWxWb3RlT3B0aW9uKVxuICAgIGlmICh0aGlzLm9wdGlvbnMpIHtcbiAgICAgIHRoaXMubnVtT3B0aW9ucy53cml0ZVVJbnQzMkJFKHRoaXMub3B0aW9ucy5sZW5ndGgsIDApXG4gICAgfVxuICAgIHJldHVybiB0aGlzLm9wdGlvbnMubGVuZ3RoIC0gMVxuICB9XG5cbiAgc2VyaWFsaXplKGVuY29kaW5nOiBTZXJpYWxpemVkRW5jb2RpbmcgPSBcImhleFwiKTogb2JqZWN0IHtcbiAgICBsZXQgZmllbGRzID0ge1xuICAgICAgc3RhcnQ6IHNlcmlhbGl6YXRpb24uZW5jb2Rlcih0aGlzLnN0YXJ0LCBlbmNvZGluZywgXCJCdWZmZXJcIiwgXCJudW1iZXJcIiksXG4gICAgICBlbmQ6IHNlcmlhbGl6YXRpb24uZW5jb2Rlcih0aGlzLmVuZCwgZW5jb2RpbmcsIFwiQnVmZmVyXCIsIFwibnVtYmVyXCIpLFxuICAgICAgb3B0aW9uczogdGhpcy5vcHRpb25zLm1hcCgob3B0KSA9PiBvcHQuc2VyaWFsaXplKGVuY29kaW5nKSksXG4gICAgICB0b3RhbFZvdGVkVGhyZXNob2xkTm9taW5hdG9yOiBzZXJpYWxpemF0aW9uLmVuY29kZXIoXG4gICAgICAgIHRoaXMudG90YWxWb3RlZFRocmVzaG9sZE5vbWluYXRvcixcbiAgICAgICAgZW5jb2RpbmcsXG4gICAgICAgIFwiQnVmZmVyXCIsXG4gICAgICAgIFwibnVtYmVyXCJcbiAgICAgICksXG4gICAgICBtb3N0Vm90ZWRUaHJlc2hvbGROb21pbmF0b3I6IHNlcmlhbGl6YXRpb24uZW5jb2RlcihcbiAgICAgICAgdGhpcy5tb3N0Vm90ZWRUaHJlc2hvbGROb21pbmF0b3IsXG4gICAgICAgIGVuY29kaW5nLFxuICAgICAgICBcIkJ1ZmZlclwiLFxuICAgICAgICBcIm51bWJlclwiXG4gICAgICApLFxuICAgICAgYWxsb3dFYXJseUZpbmlzaDogdGhpcy5hbGxvd0Vhcmx5RmluaXNoXG4gICAgfVxuICAgIHJldHVybiBmaWVsZHNcbiAgfVxuXG4gIGRlc2VyaWFsaXplKGZpZWxkczogb2JqZWN0LCBlbmNvZGluZzogU2VyaWFsaXplZEVuY29kaW5nID0gXCJoZXhcIik6IHRoaXMge1xuICAgIHRoaXMubnVtT3B0aW9ucy53cml0ZVVJbnQzMkJFKHRoaXMub3B0aW9ucy5sZW5ndGgsIDApXG4gICAgdGhpcy5vcHRpb25zID0gZmllbGRzW1wib3B0aW9uc1wiXS5tYXAoKG9wdCkgPT5cbiAgICAgIG5ldyBHZW5lcmFsVm90ZU9wdGlvbigpLmRlc2VyaWFsaXplKG9wdCwgZW5jb2RpbmcpXG4gICAgKVxuICAgIHRoaXMuc3RhcnQgPSBzZXJpYWxpemF0aW9uLmRlY29kZXIoXG4gICAgICBmaWVsZHNbXCJzdGFydFwiXSxcbiAgICAgIGVuY29kaW5nLFxuICAgICAgXCJudW1iZXJcIixcbiAgICAgIFwiQnVmZmVyXCJcbiAgICApXG4gICAgdGhpcy5lbmQgPSBzZXJpYWxpemF0aW9uLmRlY29kZXIoXG4gICAgICBmaWVsZHNbXCJlbmRcIl0sXG4gICAgICBlbmNvZGluZyxcbiAgICAgIFwibnVtYmVyXCIsXG4gICAgICBcIkJ1ZmZlclwiXG4gICAgKVxuICAgIHRoaXMudG90YWxWb3RlZFRocmVzaG9sZE5vbWluYXRvciA9IHNlcmlhbGl6YXRpb24uZGVjb2RlcihcbiAgICAgIGZpZWxkc1tcInRvdGFsVm90ZWRUaHJlc2hvbGROb21pbmF0b3JcIl0sXG4gICAgICBlbmNvZGluZyxcbiAgICAgIFwibnVtYmVyXCIsXG4gICAgICBcIkJ1ZmZlclwiXG4gICAgKVxuICAgIHRoaXMubW9zdFZvdGVkVGhyZXNob2xkTm9taW5hdG9yID0gc2VyaWFsaXphdGlvbi5kZWNvZGVyKFxuICAgICAgZmllbGRzW1wibW9zdFZvdGVkVGhyZXNob2xkTm9taW5hdG9yXCJdLFxuICAgICAgZW5jb2RpbmcsXG4gICAgICBcIm51bWJlclwiLFxuICAgICAgXCJCdWZmZXJcIlxuICAgIClcblxuICAgIHRoaXMuYWxsb3dFYXJseUZpbmlzaCA9IHNlcmlhbGl6YXRpb24uZGVjb2RlcihcbiAgICAgIGZpZWxkc1tcImFsbG93RWFybHlGaW5pc2hcIl0sXG4gICAgICBlbmNvZGluZyxcbiAgICAgIFwibnVtYmVyXCIsXG4gICAgICBcIkJ1ZmZlclwiXG4gICAgKVxuXG4gICAgcmV0dXJuIHRoaXNcbiAgfVxuXG4gIGZyb21CdWZmZXIoYnl0ZXM6IEJ1ZmZlciwgb2Zmc2V0OiBudW1iZXIgPSAwKTogbnVtYmVyIHtcbiAgICB0aGlzLm51bU9wdGlvbnMgPSBiaW50b29scy5jb3B5RnJvbShieXRlcywgb2Zmc2V0LCBvZmZzZXQgKyA0KSAvLyB0aGlzLm51bU9wdGlvbnMucmVhZFVJbnQzMkJFKDApXG4gICAgb2Zmc2V0ICs9IDRcbiAgICBjb25zdCBvcHRpb25Db3VudCA9IHRoaXMubnVtT3B0aW9ucy5yZWFkVUludDMyQkUoMClcbiAgICB0aGlzLm9wdGlvbnMgPSBbXVxuICAgIGZvciAobGV0IGkgPSAwOyBpIDwgb3B0aW9uQ291bnQ7IGkrKykge1xuICAgICAgY29uc3Qgb3B0aW9uID0gbmV3IEdlbmVyYWxWb3RlT3B0aW9uKClcbiAgICAgIG9mZnNldCA9IG9wdGlvbi5mcm9tQnVmZmVyKGJ5dGVzLCBvZmZzZXQpXG4gICAgICB0aGlzLm9wdGlvbnMucHVzaChvcHRpb24pXG4gICAgfVxuICAgIHRoaXMuc3RhcnQgPSBiaW50b29scy5jb3B5RnJvbShieXRlcywgb2Zmc2V0LCBvZmZzZXQgKyA4KVxuICAgIG9mZnNldCArPSA4XG4gICAgdGhpcy5lbmQgPSBiaW50b29scy5jb3B5RnJvbShieXRlcywgb2Zmc2V0LCBvZmZzZXQgKyA4KVxuICAgIG9mZnNldCArPSA4XG4gICAgdGhpcy50b3RhbFZvdGVkVGhyZXNob2xkTm9taW5hdG9yID0gYmludG9vbHMuY29weUZyb20oXG4gICAgICBieXRlcyxcbiAgICAgIG9mZnNldCxcbiAgICAgIG9mZnNldCArIDhcbiAgICApXG4gICAgb2Zmc2V0ICs9IDhcbiAgICB0aGlzLm1vc3RWb3RlZFRocmVzaG9sZE5vbWluYXRvciA9IGJpbnRvb2xzLmNvcHlGcm9tKFxuICAgICAgYnl0ZXMsXG4gICAgICBvZmZzZXQsXG4gICAgICBvZmZzZXQgKyA4XG4gICAgKVxuICAgIG9mZnNldCArPSA4XG5cbiAgICB0aGlzLmFsbG93RWFybHlGaW5pc2ggPSBiaW50b29scy5jb3B5RnJvbShieXRlcywgb2Zmc2V0LCBvZmZzZXQgKyAxKVswXSAhPSAwXG4gICAgb2Zmc2V0ICs9IDFcblxuICAgIHJldHVybiBvZmZzZXRcbiAgfVxuXG4gIHRvQnVmZmVyKCk6IEJ1ZmZlciB7XG4gICAgbGV0IGJhcnIgPSBbdGhpcy5udW1PcHRpb25zXVxuICAgIGxldCBic2l6ZSA9IHRoaXMubnVtT3B0aW9ucy5sZW5ndGhcblxuICAgIHRoaXMub3B0aW9ucy5mb3JFYWNoKChvcHQpID0+IHtcbiAgICAgIGxldCBvcHRCdWZmZXIgPSBvcHQudG9CdWZmZXIoKVxuICAgICAgYmFyci5wdXNoKG9wdEJ1ZmZlcilcbiAgICAgIGJzaXplICs9IG9wdEJ1ZmZlci5sZW5ndGhcbiAgICB9KVxuXG4gICAgYmFyci5wdXNoKFxuICAgICAgdGhpcy5zdGFydCxcbiAgICAgIHRoaXMuZW5kLFxuICAgICAgdGhpcy50b3RhbFZvdGVkVGhyZXNob2xkTm9taW5hdG9yLFxuICAgICAgdGhpcy5tb3N0Vm90ZWRUaHJlc2hvbGROb21pbmF0b3IsXG4gICAgICBCdWZmZXIuZnJvbShbdGhpcy5hbGxvd0Vhcmx5RmluaXNoID8gMSA6IDBdKVxuICAgIClcblxuICAgIGJzaXplICs9XG4gICAgICB0aGlzLnN0YXJ0Lmxlbmd0aCArXG4gICAgICB0aGlzLmVuZC5sZW5ndGggK1xuICAgICAgdGhpcy50b3RhbFZvdGVkVGhyZXNob2xkTm9taW5hdG9yLmxlbmd0aCArXG4gICAgICB0aGlzLm1vc3RWb3RlZFRocmVzaG9sZE5vbWluYXRvci5sZW5ndGggK1xuICAgICAgMVxuXG4gICAgcmV0dXJuIEJ1ZmZlci5jb25jYXQoYmFyciwgYnNpemUpXG4gIH1cblxuICBjb25zdHJ1Y3RvcihcbiAgICBzdGFydD86IG51bWJlcixcbiAgICBlbmQ/OiBudW1iZXIsXG4gICAgdG90YWxWb3RlZFRocmVzaG9sZE5vbWluYXRvcj86IG51bWJlcixcbiAgICBtb3N0Vm90ZWRUaHJlc2hvbGROb21pbmF0b3I/OiBudW1iZXIsXG4gICAgYWxsb3dFYXJseUZpbmlzaD86IGJvb2xlYW5cbiAgKSB7XG4gICAgY29uc3Qgc3RhcnRUaW1lID0gQnVmZmVyLmFsbG9jKDgpIC8vIEJ1ZmZlciB0byBob2xkIHRoZSBzdGFydCB0aW1lLCA4IGJ5dGVzXG4gICAgc3RhcnRUaW1lLndyaXRlVUludDMyQkUoc3RhcnQsIDQpXG4gICAgY29uc3QgZW5kVGltZSA9IEJ1ZmZlci5hbGxvYyg4KSAvLyBCdWZmZXIgdG8gaG9sZCB0aGUgZW5kIHRpbWUsIDggYnl0ZXNcbiAgICBlbmRUaW1lLndyaXRlVUludDMyQkUoZW5kLCA0KVxuXG4gICAgdGhpcy5vcHRpb25zID0gW11cbiAgICB0aGlzLnN0YXJ0ID0gc3RhcnRUaW1lXG4gICAgdGhpcy5lbmQgPSBlbmRUaW1lXG5cbiAgICB0aGlzLnRvdGFsVm90ZWRUaHJlc2hvbGROb21pbmF0b3IgPSBCdWZmZXIuYWxsb2MoOClcbiAgICB0aGlzLnRvdGFsVm90ZWRUaHJlc2hvbGROb21pbmF0b3Iud3JpdGVVSW50MzJCRShcbiAgICAgIHRvdGFsVm90ZWRUaHJlc2hvbGROb21pbmF0b3IsXG4gICAgICAwXG4gICAgKVxuICAgIHRoaXMubW9zdFZvdGVkVGhyZXNob2xkTm9taW5hdG9yID0gQnVmZmVyLmFsbG9jKDgpXG4gICAgdGhpcy5tb3N0Vm90ZWRUaHJlc2hvbGROb21pbmF0b3Iud3JpdGVVSW50MzJCRShcbiAgICAgIG1vc3RWb3RlZFRocmVzaG9sZE5vbWluYXRvcixcbiAgICAgIDBcbiAgICApXG4gICAgdGhpcy5hbGxvd0Vhcmx5RmluaXNoID0gYWxsb3dFYXJseUZpbmlzaFxuICB9XG5cbiAgZ2V0VHlwZUlEKCk6IG51bWJlciB7XG4gICAgcmV0dXJuIHRoaXMuX3R5cGVJRFxuICB9XG5cbiAgZ2V0QWxsb3dFYXJseUZpbmlzaCgpOiBib29sZWFuIHtcbiAgICByZXR1cm4gdGhpcy5hbGxvd0Vhcmx5RmluaXNoXG4gIH1cbn1cbiJdfQ==